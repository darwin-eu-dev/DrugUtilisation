---
title: "Obtain treatment summary of a cohort"
author: "Martí Català"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Obtain treatment summary of a cohort}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

The DrugUtilisation package incorporates a function to summarise the
dose table over multiple cohorts: `summariseTreatment()`. In this
vignette, we will explore the functionalities and usages of this
function.

## Create mock table

We will use mock data contained in the package thoughout the vignette. Let's
modify cohort tables `cohort1` and `cohort2` in our mock dataset, so the frist
includes 3 subcohorts of health conditions, while the second contains three 
treatments.

```{r, message = FALSE, warning=FALSE}
library(DrugUtilisation)
library(CDMConnector)
library(dplyr)
library(PatientProfiles)

cdm <- mockDrugUtilisation(numberIndividual = 200)

new_cohort_set <- settings(cdm$cohort1) %>%
  dplyr::arrange(cohort_definition_id) %>%
  dplyr::mutate(cohort_name = c("asthma","bronchitis","pneumonia"))

cdm$cohort1 <- cdm$cohort1 |>
  newCohortTable(cohortSetRef = new_cohort_set)

new_cohort_set <- settings(cdm$cohort2) %>%
  dplyr::arrange(cohort_definition_id) %>%
  dplyr::mutate(cohort_name = c("albuterol","fluticasone","montelukast"))

cdm$cohort2 <- cdm$cohort2 |>
  newCohortTable(cohortSetRef = new_cohort_set)

```


Notice that `cohort1` is a cohort with three subcohorts representing
three different conditions:

```{r, message = FALSE, warning=FALSE}
settings(cdm$cohort1)
```

And `cohort2` is a cohort with three different treatments:

```{r, message = FALSE, warning=FALSE}
settings(cdm$cohort2)
```

# Summarise treatment 

`summariseTreatment()` function creates a standarised tibble
summarising the treatment information (already specified in an existing cohort) over multiple cohorts. There are three mandatory arguments:

1.  `cohort`: cohort from the cdm object.
2.  `treatmentCohortName`: name of the treatment cohort's table.
3.  `window`: list of the windows where to summarise the treatments.

See an example of its usage below, where we use
`summariseTreatment()` to summarise treatments defined in
`cohort2` in the cohorts defined in `cohort1`.

```{r, message = FALSE, warning=FALSE}
summariseTreatment(cohort = cdm$cohort1,
                   treatmentCohortName = c("cohort2"),
                   window = list(c(0,0), c(1,30)))
```

## strata parameter

We can also stratify our cohort and calculate the estimates within each
strata group by using the `strata` parameter.

```{r, message = FALSE, warning=FALSE}
cdm[["cohort1"]] <- cdm[["cohort1"]] %>%
  addSex() %>%
  addAge(ageGroup = list("<40" = c(0, 39), ">=40" = c(40, 150)))

results <- summariseTreatment(
  cohort = cdm$cohort1,
  treatmentCohortName = c("cohort2"),
  window = list(c(0,0)),
  treatmentCohortId = 1,
  strata = list("sex", "age_group")
)
```

Notice that we have also used the `treatmentCohortId` parameter to
specify that we only want to explore `albuterol` across the cohorts defined in
`cohort1`.


# Visualise results

The package includes `table` and `plot` functions to help visualise the results from `summariseTreatment()`.

## Tables

The `tableTreatment()` function generates a table in gt, flextable, or tibble format from the summarised_result produced by `summariseTreatment()`. This function has customisation options to format the table according to user preferences.

```{r}
tableTreatment(
  result = results,
  header = c("strata"),
  splitStrata = FALSE,
  cdmName = FALSE,
  groupColumn = c("cohort_name"),
  type = "gt",
  formatEstimateName = c("N (%)" = "<count> (<percentage> %)"),
  .options = list()
)
```

## Plots

The `plotTreatment()` function creates a bar plot showing the percentage of treated and untreated in each cohort, stratum, and time-window. This function offers customization options for colors, faceting, and handling of strata.

```{r, fig.height=8, fig.width=8}
plotTreatment(
  result = results,
  facetX = c("cohort_name", "window_name"),
  facetY = c("strata"),
  splitStrata = TRUE,
  colour = "treatment"
)
```
