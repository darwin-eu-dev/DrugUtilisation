---
title: "Use DrugUtilisation to create a cohort"
author: "Martí Català, Mike Du, Yuchen Guo, Kim Lopez-Guell, Edward Burn, Xintong Li"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Use DrugUtilisation to create a cohort}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{r , include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

In this vignette we will introduce how to create a drug users cohorts. A cohort is a set of people that satisfy a certain inclusion criteria durng a certain time frame. The cohort object is defined in : `vignette("a03_cohort_table", package = "omopgenerics")`.

The function `generateDrugUtilisationCohortSet` is used to generate cohorts of drug users based on the drug_exposure table and a conceptSet.

These cohorts can be subsetted to the exposures of interest applying the different inclusion criteria:

- Require that entries are in a certain date range `requireDrugInDateRange`.

- Subset to the first entry `requireIsFirstDrugEntry`.

- Require a certain time in observation before the entries `requireObservationBeforeDrug`.

- Require a certain time before exposure `requirePriorDrugWashout`.

# Creating a `cdm_reference` object

The first thing that we need is a cdm reference object to our OMOP CDM instance. You can learn how to create cdm references using CDMConnector here: CDMConnector::a04_DBI_connection_examples

The DrugUtilisation packages contains some mock data that can be useful to test the package:

```{r}
library(DrugUtilisation)

cdm <- mockDrugUtilisation(numberIndividuals = 100)

cdm
```

# Create a drug users cohort

To create a basic drug users cohort we need two things:

- A conceptSet: will determine which concepts we will use.
- A gapEra: will determine how we will collapse those exposures.

## Creating a conceptSet

There are four possible outputs for a conceptSet:

- A named list of concept ids
```{r}
conceptSet <- list(acetaminophen = c(1, 2, 3))
conceptSet
```
- A `codelist` object, see omopgenerics "a02_concept_set"
```{r}
conceptSet <- list(acetaminophen = c(1, 2, 3)) |> omopgenerics::newCodelist()
conceptSet
conceptSet$acetaminophen
```
- A `codelist_with_details` object, see omopgenerics "a02_concept_set"
```{r}
conceptSet <- list(acetaminophen = dplyr::tibble(
  concept_id = c(1125315, 1125360),
  concept_name = c("acetaminophen", "acetaminophen 500 MG Oral Capsule"),
  domain_id = "Drug",
  vocabulary_id = "RxNorm",
  standard_concept = "S"
)) |> 
  omopgenerics::newCodelistWithDetails()
conceptSet
conceptSet$acetaminophen
```

- A `conceptSetExpression` object, see omopgenerics "a02_concept_set"

```{r}
conceptSet <- list(acetaminophen = dplyr::tibble(
  concept_id = 1125315, 
  excluded = FALSE,
  descendants = TRUE,
  mapped = FALSE
)) |> 
  omopgenerics::newConceptSetExpression()
conceptSet
conceptSet$acetaminophen
```

The package [CodelistGenerator](https://cran.r-project.org/package=CodelistGenerator) can be very useful to create conceptSet.

```{r}
library(CodelistGenerator)
```

For example we can create a conceptSet based in an ingredient with `getDrugIngredientCodes()`:
```{r}
codes <- getDrugIngredientCodes(cdm = cdm, name = "acetaminophen")
codes[["161_acetaminophen"]]
```



See more information in CodelistGenerator vignettes.
- ingredient
- json file
- codelist
- atc

## The gapEra parameter

# Apply inclusion criteria to drug cohorts

# The order matters

# Alternatives to create cohorts

`generateDrugUtilisationCohortSet()` is a very specif function to create drug users cohorts. Most of the functions in this package need a cohort as input, this cohort will usually be a cohort generated using `generateDrugUtilisationCohortSet()`, but there exist some alternative to create cohorts

- You can create your own custom cohorts with `tidyverse` functions and `omopgenerics::newCohortTable()`. See omopgenerics vignette.

- You can create concept based cohorts using the `OHDSI` package `CohortConstructor`. See CohortConstructor "a01_building_base_cohorts".

- You can create cohorts based on ATLAS definitions using CDMConnector. "a02_cohorts"
